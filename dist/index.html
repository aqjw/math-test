<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <!-- версия для разработки, отображает полезные предупреждения в консоли -->
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Math</title>
    <style>
        #app {
            background: #efefef;
            width: 100vw;
            height: 100vh;
        }
        .btn-custom {
            width: 100%;
            height: 60px;
        }
    </style>
</head>
<body>
    <div id="app">
        <div style="width: 300px;" class="mx-auto">
            <div class="form-group">
                <div class="row pt-3">
                    <div class="col-5 text-center"><b>{{ num1 }}</b></div>
                    <div class="col-2 text-center"><b>{{ operator }}</b></div>
                    <div class="col-5 text-center"><b>{{ num2 }}</b></div>
                </div>
            </div>
            <div class="form-group">
                <input type="number" pattern="\d*" inputmode="numeric"
                    class="form-control" v-model="prediction" ref="prediction" v-on:keyup.enter="check">
            </div>
            <div class="form-group text-center">
                <div v-if="null !== current_state" :class="[current_state ? 'text-success' : 'text-danger']">
                    {{ current_state ? 'верно' : 'неверно' }}
                </div>
                <div v-else class="text-primary">
                    введите ответ
                </div>
            </div>

            <ul class="list-group">
                <li class="list-group-item disabled text-center">Уровни</li>
                <li  class="list-group-item d-flex justify-content-between align-items-center" v-for="l, i in levels">
                    <div>#{{i+1}} - верные: {{l.stats.correct}} неверные: {{l.stats.incorrect}}</div>
                    <span class="badge badge-primary badge-pill">{{ percent(l.stats) }}%</span>
                </li>
            </ul>
        </div>

    </div>

    <script>
        var app = new Vue({
            el: '#app',
            data: {
                timer: null,
                level_steps: 20,
                current_state: null,
                prediction: 0,
                operator: null,
                num1: 0,
                num2: 0,
                level: 0,

                levels: [
                    {operators: ['+'], stats: {correct: 0, incorrect: 0}},
                    {operators: ['+', '-'], stats: {correct: 0, incorrect: 0}},
                    {operators: ['+', '-', '*'], stats: {correct: 0, incorrect: 0}},
                    {operators: ['+', '-', '*'], stats: {correct: 0, incorrect: 0}},
                    {operators: ['+', '-', '*'], stats: {correct: 0, incorrect: 0}},
                ],
            },
            watch: {
                prediction(newValue) {
                    if (newValue > 0) {
                        clearTimeout(this.timer)
                        this.timer = setTimeout(() => {
                            this.check(newValue)
                        }, 400)
                    }
                }
            },
            mounted() {
                this.generate()
            },
            methods: {
                percent(stats) {
                    if (stats.correct+stats.incorrect > 0) {
                        return Math.ceil( stats.correct*100/(stats.correct+stats.incorrect) )
                    }
                    return 0
                },
                generate() {
                    operators = this.levels[this.level].operators
                    this.operator = operators[Math.floor(Math.random() * operators.length)]

                    if (this.operator == '-') {
                        while(true) {
                            this.num1 = Math.ceil(Math.random()*(10*(this.level+1)))
                            this.num2 = Math.ceil(Math.random()*(10*(this.level+1)))
                            if (this.num1 - this.num2 > 0) break
                        }
                    } else {
                        this.num1 = Math.ceil(Math.random()*(10*(this.level+1)))
                        this.num2 = Math.ceil(Math.random()*(10*(this.level+1)))
                    }
                },
                check(prediction) {
                    real = eval(`${this.num1}${this.operator}${this.num2}`)
                    stats = this.levels[this.level].stats
                    this.$refs.prediction.focus()
                    this.prediction = null

                    if (real == prediction) {
                        this.generate()
                        this.current_state = 1
                        stats.correct++
                        if (stats.correct > stats.incorrect && stats.correct == this.level_steps) {
                            this.level++
                        }
                    } else {
                        stats.incorrect++
                        this.current_state = 0
                    }

                    setTimeout(() => {this.current_state = null}, this.current_state ? 1000 : 2000)
                }
            }
        })
    </script>
</body>
</html>